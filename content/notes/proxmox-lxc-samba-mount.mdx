---
slug: "proxmox-lxc-samba-mount"
title: "Mounting Samba Shares in Proxmox Unprivileged LXC Containers"
date: "2025-03-07"
tags: ["Proxmox", "LXC", "Samba", "Storage", "Virtualization", "File Sharing"]
---

# Mounting Samba Shares in Proxmox Unprivileged LXC Containers

## Overview

This guide covers the process of mounting Samba/CIFS shares from a network storage server into Proxmox LXC containers, including both privileged host mounting and container-specific mount points.

## Prerequisites

- Proxmox VE host with LXC containers
- Samba/CIFS server with shared directories
- Network connectivity between Proxmox host and Samba server
- Appropriate user credentials for Samba access

## Step 1: Mount Samba Share on Proxmox Host

### Install Required Packages

```bash
apt update
apt install cifs-utils -y
```

### Create Credentials File

Create a secure credentials file to store Samba authentication:

```bash
sudo nano /etc/samba/ukapi_creds
```

Add the following content:
```
username=samba_user
password=samba_password
```

Secure the credentials file:
```bash
sudo chmod 600 /etc/samba/ukapi_creds
```

### Create Mount Point and Mount Share

```bash
# Create mount directory
mkdir -p /mnt/ukapi_samba

# Mount the Samba share
mount -t cifs //192.168.10.20/shared /mnt/ukapi_samba -o credentials=/etc/samba/ukapi_creds
```

### Verify Mount

```bash
# Check if mount is successful
df -h | grep ukapi_samba
ls -la /mnt/ukapi_samba
```

## Step 2: Configure Automatic Mounting

### Add to /etc/fstab

To ensure the Samba share mounts automatically on boot:

```bash
nano /etc/fstab
```

Add the following line:
```
//192.168.10.20/shared /mnt/ukapi_samba cifs credentials=/etc/samba/ukapi_creds,uid=1000,gid=1000,iocharset=utf8 0 0
```

### Test Automatic Mount

```bash
# Unmount to test
umount /mnt/ukapi_samba

# Test fstab entry
mount -a

# Verify mount
df -h | grep ukapi_samba
```

## Step 3: Mount Share into LXC Container

### Stop the LXC Container

Before modifying container configuration, ensure the container is stopped:

```bash
pct stop 101
```

### Edit LXC Configuration

Edit the container configuration file:

```bash
nano /etc/pve/lxc/101.conf
```

Add a mount point entry:
```
mp0: /mnt/ukapi_samba/jellyfin,mp=/mnt/ukapi_jellyfin
```

### Configuration Parameters Explained

- `mp0`: Mount point identifier (can be mp0, mp1, mp2, etc.)
- `/mnt/ukapi_samba/jellyfin`: Source path on Proxmox host
- `mp=/mnt/ukapi_jellyfin`: Destination path inside the container

### Additional Mount Options

For more advanced configurations, you can add additional options:

```
mp0: /mnt/ukapi_samba/jellyfin,mp=/mnt/ukapi_jellyfin,backup=0,ro=0
```

Options:
- `backup=0`: Exclude from container backups
- `ro=0`: Read-write access (ro=1 for read-only)
- `shared=1`: Allow multiple containers to access the same mount

## Step 4: Start Container and Verify

### Start the LXC Container

```bash
pct start 101
```

### Verify Mount Inside Container

Enter the container and check the mount:

```bash
# Enter container
pct enter 101

# Check mount point
ls -la /mnt/ukapi_jellyfin
df -h | grep ukapi_jellyfin

# Test write access (if applicable)
touch /mnt/ukapi_jellyfin/test_file
```

## Advanced Configuration

### Multiple Mount Points

You can add multiple mount points to a single container:

```
mp0: /mnt/ukapi_samba/jellyfin,mp=/mnt/ukapi_jellyfin
mp1: /mnt/ukapi_samba/nextcloud,mp=/mnt/ukapi_nextcloud
mp2: /mnt/ukapi_samba/backup,mp=/mnt/backup,ro=1
```

### Permissions and Ownership

For proper file permissions, especially with unprivileged containers:

```bash
# On Proxmox host, set appropriate ownership
chown -R 100000:100000 /mnt/ukapi_samba/jellyfin

# Or use specific UID/GID mapping
chown -R 101000:101000 /mnt/ukapi_samba/jellyfin
```

### Samba Mount Options

For better performance and compatibility, use additional mount options in fstab:

```
//192.168.10.20/shared /mnt/ukapi_samba cifs credentials=/etc/samba/ukapi_creds,uid=1000,gid=1000,iocharset=utf8,file_mode=0777,dir_mode=0777,vers=3.0 0 0
```

Additional options:
- `vers=3.0`: Specify SMB protocol version
- `file_mode=0777`: Set file permissions
- `dir_mode=0777`: Set directory permissions
- `nobrl`: Disable byte range locking (useful for some applications)

## Troubleshooting

### Common Issues

**Issue**: Mount fails with "Permission denied"
**Solution**: 
- Verify Samba credentials are correct
- Check network connectivity to Samba server
- Ensure Samba server allows connections from Proxmox host IP

**Issue**: Files not accessible inside container
**Solution**:
- Check UID/GID mapping between host and container
- Verify mount point permissions on host
- Ensure container has appropriate privileges

**Issue**: Mount disappears after reboot
**Solution**:
- Verify /etc/fstab entry is correct
- Check if Samba server is available during boot
- Consider adding delay or dependency in systemd

### Debugging Commands

```bash
# Check Samba connectivity
smbclient -L //192.168.10.20 -U samba_user

# Test mount manually with verbose output
mount -t cifs //192.168.10.20/shared /mnt/test -o credentials=/etc/samba/ukapi_creds,verbose

# Check container configuration
pct config 101

# Monitor container logs
pct enter 101
dmesg | grep -i cifs
```

### Performance Optimization

For better performance with large files or high I/O:

```
//192.168.10.20/shared /mnt/ukapi_samba cifs credentials=/etc/samba/ukapi_creds,cache=strict,rsize=1048576,wsize=1048576 0 0
```

Options:
- `cache=strict`: Enable aggressive caching
- `rsize=1048576`: Set read buffer size (1MB)
- `wsize=1048576`: Set write buffer size (1MB)

## Security Considerations

1. **Credentials Security**: Ensure credentials file has restrictive permissions (600)
2. **Network Security**: Use SMB3 or higher for encryption
3. **Access Control**: Limit Samba share access to specific IP ranges
4. **Container Isolation**: Consider security implications of shared storage

## Use Cases

### Media Server (Jellyfin/Plex)
```
mp0: /mnt/ukapi_samba/media,mp=/media,ro=1
```

### File Sync Service (Nextcloud)
```
mp0: /mnt/ukapi_samba/nextcloud,mp=/var/www/nextcloud/data
```

### Backup Storage
```
mp0: /mnt/ukapi_samba/backup,mp=/backup,backup=0
```

## Related Resources

- [Proxmox LXC Documentation](https://pve.proxmox.com/wiki/Linux_Container)
- [CIFS Mount Options](https://www.kernel.org/doc/Documentation/filesystems/cifs/README)
- [Samba Configuration Guide](https://www.samba.org/samba/docs/)
- [LXC Mount Points](https://pve.proxmox.com/wiki/Linux_Container#_mount_points)
