---
title: "OPNsense WireGuard VPN with Zero Trust Architecture"
date: "2024-03-20"
year: 2024
summary: "Implemented secure remote access VPN with WireGuard on OPNsense, featuring certificate-based authentication and network segmentation"
tags: ["OPNsense", "VPN", "WireGuard", "Security", "Zero Trust"]
cover: "/images/projects/opnsense-logo.png"
repo: "https://github.com/jqiu006/opnsense-configs"
tech: ["OPNsense", "WireGuard", "PKI", "Suricata", "Unbound DNS"]
status: "completed"
---

# Project Overview

As remote work became more prevalent, I needed a secure way to access my homelab resources from anywhere. Traditional VPN solutions felt outdated, so I implemented a modern WireGuard-based VPN with zero trust principles.

## Goals

- **Secure Remote Access**: Encrypted tunnel to homelab resources
- **Zero Trust Model**: Authenticate and authorize every connection
- **Network Segmentation**: Limit access based on user roles
- **Performance**: Low latency, high throughput connections
- **Monitoring**: Comprehensive logging and alerting

## Architecture

### Network Topology

```
Internet → OPNsense Firewall → WireGuard Server
                            → Internal Networks (VLANs)
                            → DMZ (Public Services)
                            → Management Network
```

### Certificate Authority Setup

Implemented internal PKI for certificate-based authentication:

```bash
# Generate CA certificate
openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 3650 -key ca.key -out ca.crt

# Generate client certificates
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -out client.crt
```

## Implementation Details

### WireGuard Configuration

Server configuration on OPNsense:

```ini
[Interface]
PrivateKey = <server-private-key>
Address = 10.100.0.1/24
ListenPort = 51820
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT

[Peer]
PublicKey = <client-public-key>
AllowedIPs = 10.100.0.2/32
```

### Firewall Rules

Implemented granular access control:

1. **Admin Access**: Full network access for administrators
2. **Developer Access**: Limited to development VLANs
3. **Guest Access**: Internet only, no internal network access

### DNS Configuration

Configured Unbound DNS for internal name resolution:

```
# Internal domain resolution
homelab.local → 192.168.10.0/24
dev.homelab.local → 192.168.20.0/24
```

## Security Enhancements

### Intrusion Detection

Deployed Suricata IDS/IPS with custom rules:

```yaml
# Custom rule for VPN monitoring
alert tcp any any -> 10.100.0.0/24 any (msg:"VPN Access Attempt"; sid:1000001;)
```

### Access Logging

Implemented comprehensive logging:
- Connection attempts and successes
- Data transfer volumes
- Failed authentication attempts
- Unusual traffic patterns

## Performance Results

### Throughput Testing

```bash
# iperf3 testing results
VPN Throughput: 850 Mbps (95% of baseline)
Latency: +2ms overhead
CPU Usage: <5% on OPNsense appliance
```

### Connection Metrics

- **Connection Time**: <2 seconds
- **Reconnection**: Automatic with 30-second timeout
- **Concurrent Users**: Tested up to 50 simultaneous connections

## Monitoring & Alerting

### Grafana Dashboard

Created custom dashboard tracking:
- Active VPN connections
- Bandwidth utilization
- Authentication failures
- Certificate expiration dates

### Alert Rules

```yaml
# Certificate expiration warning
- alert: CertificateExpiring
  expr: cert_expiry_days < 30
  for: 1h
  annotations:
    summary: "VPN certificate expiring soon"
```

## Lessons Learned

1. **Certificate Management**: Automated renewal is essential for production use
2. **Network Design**: Proper subnetting prevents routing conflicts
3. **Performance Tuning**: WireGuard parameters need optimization for specific use cases
4. **User Experience**: Simple client configuration improves adoption

## Future Improvements

- [ ] Implement SAML/OIDC integration for enterprise authentication
- [ ] Add geo-blocking for additional security
- [ ] Deploy redundant VPN servers for high availability
- [ ] Integrate with SIEM for advanced threat detection

## Configuration Files

All configuration files and automation scripts are available in the [project repository](https://github.com/jqiu006/opnsense-configs).
